<?xml version='1.0'?>

<effect>
	<include name="PostProcess.fxml"/>
	<include name="util.fxml"/>

	<parameter type="sampler" name="point_sampler">
		<state name="filtering" value="min_mag_mip_point"/>
		<state name="address_u" value="clamp"/>
		<state name="address_v" value="clamp"/>
	</parameter>
	<parameter type="sampler" name="bilinear_sampler">
		<state name="filtering" value="min_mag_linear_mip_point"/>
		<state name="address_u" value="clamp"/>
		<state name="address_v" value="clamp"/>
	</parameter>

	<cbuffer>
		<parameter type="float2" name="src_offset"/>
		<parameter type="float2" name="src_scale"/>
		<parameter type="float2" name="dst_offset"/>
		<parameter type="float2" name="dst_scale"/>
		<parameter type="int" name="src_array_index"/>
		<parameter type="int" name="src_level"/>
	</cbuffer>

	<parameter type="texture2D" name="src_tex"/>
	<parameter type="texture2DArray" name="src_tex_array"/>

	<shader>
		<![CDATA[
void Blit2DVS(float4 pos : POSITION,
					out float2 oTex : TEXCOORD0,
					out float4 oPos : SV_Position)
{
	oTex = TexCoordFromPos(pos) * src_scale + src_offset;
	oPos = float4(pos.xy * dst_scale + dst_offset, pos.zw);
}

float4 Blit2DPS(float2 tc : TEXCOORD0) : SV_Target
{
	return Tex2DSampleLevel(src_tex,
#if LINEAR_SAMPLER
		bilinear_sampler,
#else
		point_sampler,
#endif
		tc, src_level, 0);
}

float4 Blit2DArrayPS(float2 tc : TEXCOORD0) : SV_Target
{
	return Tex2DArraySampleLevel(src_tex_array,
#if LINEAR_SAMPLER
		bilinear_sampler,
#else
		point_sampler,
#endif
		float3(tc, src_array_index), src_level, 0);
}
		]]>
	</shader>

	<technique name="BlitPoint2D">
		<pass name="p0">
			<macro name="LINEAR_SAMPLER" value="0"/>
			
			<state name="depth_enable" value="false"/>
			<state name="depth_write_mask" value="false"/>

			<state name="vertex_shader" value="Blit2DVS()"/>
			<state name="pixel_shader" value="Blit2DPS()"/>
		</pass>
	</technique>
	<technique name="BlitPoint2DArray" inherit="BlitPoint2D">
		<pass name="p0">
			<macro name="LINEAR_SAMPLER" value="0"/>
			<state name="pixel_shader" value="Blit2DArrayPS()"/>
		</pass>
	</technique>

	<technique name="BlitLinear2D" inherit="BlitPoint2D">
		<pass name="p0">
			<macro name="LINEAR_SAMPLER" value="1"/>
			<state name="pixel_shader" value="Blit2DPS()"/>
		</pass>
	</technique>
	<technique name="BlitLinear2DArray" inherit="BlitPoint2DArray">
		<pass name="p0">
			<macro name="LINEAR_SAMPLER" value="1"/>
			<state name="pixel_shader" value="Blit2DArrayPS()"/>
		</pass>
	</technique>

	<technique name="Blit2DToBuffer">
		<pass name="p0">
			<macro name="LINEAR_SAMPLER" value="0"/>

			<state name="depth_enable" value="false"/>
			<state name="depth_write_mask" value="false"/>

			<state name="vertex_shader" value="Blit2DVS()"/>
			<state name="pixel_shader" value="Blit2DPS()"/>
		</pass>
	</technique>
	<technique name="Blit2DArrayToBuffer" inherit="Blit2DToBuffer">
		<pass name="p0">
			<macro name="LINEAR_SAMPLER" value="0"/>
			<state name="pixel_shader" value="Blit2DArrayPS()"/>
		</pass>
	</technique>
</effect>
